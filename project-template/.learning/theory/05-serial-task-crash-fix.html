<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serial Task Crash Fix - ESP32 Tutorial</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 2em;
            color: #1e3c72;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #dc3545;
        }

        .problem-box {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-left: 5px solid #dc3545;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .problem-box h3 {
            color: #c62828;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .problem-box h3::before {
            content: "‚ö†Ô∏è";
            margin-right: 10px;
            font-size: 1.2em;
        }

        .solution-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 5px solid #4caf50;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .solution-box h3 {
            color: #1b5e20;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .solution-box h3::before {
            content: "‚úÖ";
            margin-right: 10px;
            font-size: 1.2em;
        }

        .info-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 5px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .info-box h3 {
            color: #1565c0;
            margin-bottom: 10px;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', Consolas, Monaco, monospace;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: auto;
            margin: 15px 0;
        }

        .code-block.before {
            border-left: 5px solid #dc3545;
        }

        .code-block.after {
            border-left: 5px solid #4caf50;
        }

        .code-label {
            background: #1e3c72;
            color: white;
            padding: 8px 15px;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
            display: inline-block;
            margin-top: 20px;
        }

        .code-label.before {
            background: #dc3545;
        }

        .code-label.after {
            background: #4caf50;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .comparison-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .comparison-item h4 {
            margin-bottom: 15px;
            color: #1e3c72;
        }

        .comparison-item.bad {
            border: 2px solid #dc3545;
        }

        .comparison-item.good {
            border: 2px solid #4caf50;
        }

        .keyword {
            color: #c678dd;
            font-weight: bold;
        }

        .function {
            color: #61afef;
        }

        .string {
            color: #98c379;
        }

        .comment {
            color: #5c6370;
            font-style: italic;
        }

        .number {
            color: #d19a66;
        }

        ul, ol {
            margin-left: 30px;
            margin-top: 10px;
        }

        li {
            margin: 8px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        table tr:hover {
            background: #f5f5f5;
        }

        .mermaid-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Serial Task Crash Fix</h1>
            <p class="subtitle">Debugging Watchdog Timeouts, Stack Overflow, and Input Handling</p>
        </div>

        <div class="content">
            <!-- Problem Analysis -->
            <div class="section">
                <h2 class="section-title">üêõ The Problem</h2>
                
                <div class="problem-box">
                    <h3>System Crash Symptoms</h3>
                    <ul>
                        <li>ESP32 reboots unexpectedly</li>
                        <li>Task watchdog timeout errors</li>
                        <li>Stack overflow panic messages</li>
                        <li>Serial task stops responding</li>
                    </ul>
                </div>

                <div class="code-label before">‚ùå BROKEN CODE (Before Fix)</div>
                <div class="code-block before">void serialTask(void *pvParameter)
{
    g_serialHandle *handles = (g_serialHandle *)pvParameter;
    char localBuffer[32] = {0};
    uint16_t rxdPattern = 0;
    uint16_t rxdSpeed = 0;
    char rxtext[50] = {0};
    ESP_LOGI("SERIALTASK:", "Entered Serial Task");
    while (1)
    {
        if(scanf("%s", rxtext)>0){
            ESP_LOGI("SERIALTASK:", "Received Serial Data");
        }
        
        xQueueSend(handles->patternQHandle, &rxdPattern, 0);
        xQueueSend(handles->speedQHandle, &rxdSpeed, 0);
    }
}</div>

                <div class="code-label before">‚ùå STACK SIZE TOO SMALL</div>
                <div class="code-block before">xTaskCreate(serialTask, "SerialTask", 2048, &sHandle, 2, NULL);
//                                                      ^^^^
//                                          2048 bytes - TOO SMALL!</div>
            </div>

            <!-- Root Causes -->
            <div class="section">
                <h2 class="section-title">üéØ Root Causes Identified</h2>

                <div class="problem-box">
                    <h3>Issue #1: Infinite Tight Loop (Watchdog Timeout)</h3>
                    <p><strong>Problem:</strong> The <code>while(1)</code> loop runs continuously without any blocking call or delay.</p>
                    <p><strong>Impact:</strong> Task never yields to the RTOS scheduler, starving the IDLE task which feeds the watchdog timer.</p>
                    <p><strong>Result:</strong> Watchdog timeout after ~5 seconds ‚Üí System reset</p>
                </div>

                <div class="mermaid-container">
                    <div class="mermaid">
                        sequenceDiagram
                            participant Task as Serial Task
                            participant Sched as Scheduler
                            participant WDT as Watchdog
                            
                            Task->>Task: while(1) { ... }
                            Note over Task: No vTaskDelay()
                            Task->>Task: Spinning forever
                            Note over Sched: IDLE task never runs
                            WDT->>WDT: Timer expires
                            WDT->>Task: PANIC! Reset ESP32
                            
                            style Task fill:#ffebee,stroke:#dc3545
                            style WDT fill:#ffcdd2,stroke:#c62828
                    </div>
                </div>

                <div class="problem-box">
                    <h3>Issue #2: Stack Overflow</h3>
                    <p><strong>Problem:</strong> Task stack size = 2048 bytes, but <code>scanf()</code> needs more.</p>
                    <p><strong>Impact:</strong> Stack overflow corrupts adjacent memory ‚Üí Crash</p>
                    
                    <table>
                        <tr>
                            <th>Component</th>
                            <th>Stack Usage (approx)</th>
                        </tr>
                        <tr>
                            <td>Task context</td>
                            <td>~200 bytes</td>
                        </tr>
                        <tr>
                            <td>Local variables</td>
                            <td>~140 bytes</td>
                        </tr>
                        <tr>
                            <td><code>scanf()</code> internal buffer</td>
                            <td>~1024 bytes</td>
                        </tr>
                        <tr>
                            <td><code>fgets()</code> stdio buffer</td>
                            <td>~1024 bytes</td>
                        </tr>
                        <tr>
                            <td>Function call overhead</td>
                            <td>~200 bytes</td>
                        </tr>
                        <tr style="background: #ffebee; font-weight: bold;">
                            <td><strong>TOTAL NEEDED</strong></td>
                            <td><strong>~2600 bytes minimum</strong></td>
                        </tr>
                    </table>
                </div>

                <div class="problem-box">
                    <h3>Issue #3: Sending Uninitialized Data</h3>
                    <p><strong>Problem:</strong> <code>rxdPattern</code> and <code>rxdSpeed</code> sent to queues every loop, even when no input received.</p>
                    <p><strong>Impact:</strong> Pattern changes randomly, speed changes to garbage values.</p>
                </div>

                <div class="problem-box">
                    <h3>Issue #4: No Input Validation</h3>
                    <p><strong>Problem:</strong> User could type anything: "pattern 99", "speed -500", "destroy_world"</p>
                    <p><strong>Impact:</strong> Invalid data sent to queues ‚Üí Undefined behavior</p>
                </div>
            </div>

            <!-- The Solution -->
            <div class="section">
                <h2 class="section-title">‚úÖ The Solution</h2>

                <div class="solution-box">
                    <h3>Fix #1: Add vTaskDelay() to Yield Control</h3>
                    <p>Added <code>vTaskDelay(pdMS_TO_TICKS(100))</code> at the end of the loop.</p>
                    <p><strong>Why 100ms?</strong> Balance between responsiveness (human typing speed) and CPU efficiency.</p>
                </div>

                <div class="solution-box">
                    <h3>Fix #2: Increase Stack Size 2048 ‚Üí 4096</h3>
                    <p>Doubled the stack allocation to safely accommodate stdio operations.</p>
                    <p><strong>Rule of thumb:</strong> Tasks using <code>printf/scanf/fgets</code> need 4096+ bytes minimum.</p>
                </div>

                <div class="solution-box">
                    <h3>Fix #3: Use fgets() + sscanf() Instead of scanf()</h3>
                    <p><strong>Why better?</strong></p>
                    <ul>
                        <li><code>fgets()</code> reads entire line safely (prevents buffer overflow)</li>
                        <li><code>sscanf()</code> parses the string in memory (more control)</li>
                        <li>Can validate before acting on data</li>
                    </ul>
                </div>

                <div class="solution-box">
                    <h3>Fix #4: Validate Input Before Sending</h3>
                    <p>Check ranges: pattern (0-3), speed (50-1000) before queue operations.</p>
                </div>

                <div class="code-label after">‚úÖ FIXED CODE (After)</div>
                <div class="code-block after">void serialTask(void *pvParameter)
{
    g_serialHandle *handles = (g_serialHandle *)pvParameter;
    char rxtext[50] = {0};
    uint16_t rxdPattern = 0;
    uint16_t rxdSpeed = 0;
    
    ESP_LOGI("SERIALTASK", "Entered Serial Task");
    
    while (1)
    {
        if (fgets(rxtext, sizeof(rxtext), stdin) != NULL)
        {
            ESP_LOGI("SERIALTASK", "Received: %s", rxtext);
            
            char cmd[20] = {0};
            int value = 0;
            
            if (sscanf(rxtext, "%s %d", cmd, &value) >= 1)
            {
                if (strcmp(cmd, "pattern") == 0 && value >= 0 && value <= 3)
                {
                    rxdPattern = (uint16_t)value;
                    xQueueSend(handles->patternQHandle, &rxdPattern, 0);
                    ESP_LOGI("SERIALTASK", "Pattern changed to: %d", rxdPattern);
                }
                else if (strcmp(cmd, "speed") == 0 && value >= 50 && value <= 1000)
                {
                    rxdSpeed = (uint16_t)value;
                    xQueueSend(handles->speedQHandle, &rxdSpeed, 0);
                    ESP_LOGI("SERIALTASK", "Speed changed to: %d", rxdSpeed);
                }
                else if (strcmp(cmd, "status") == 0)
                {
                    ESP_LOGI("SERIALTASK", "Status requested");
                }
            }
        }
        
        vTaskDelay(pdMS_TO_TICKS(100));  // ‚Üê CRITICAL: Yield to scheduler
    }
}</div>

                <div class="code-label after">‚úÖ INCREASED STACK SIZE</div>
                <div class="code-block after">xTaskCreate(serialTask, "SerialTask", 4096, &sHandle, 2, NULL);
//                                                      ^^^^
//                                          4096 bytes - SAFE!</div>
            </div>

            <!-- Technical Deep Dive -->
            <div class="section">
                <h2 class="section-title">üî¨ Technical Deep Dive</h2>

                <div class="info-box">
                    <h3>Why Does Tight Loop Cause Watchdog Timeout?</h3>
                    <p><strong>FreeRTOS Task Scheduling:</strong></p>
                    <ul>
                        <li>Tasks must periodically <strong>yield</strong> (give up CPU) to allow other tasks to run</li>
                        <li>The <strong>IDLE task</strong> runs when no other tasks are ready</li>
                        <li>IDLE task <strong>feeds the watchdog timer</strong> (tells it "system is alive")</li>
                        <li>If IDLE task never runs ‚Üí Watchdog not fed ‚Üí System assumes hang ‚Üí RESET</li>
                    </ul>
                    
                    <p><strong>Blocking Operations That Auto-Yield:</strong></p>
                    <ul>
                        <li><code>vTaskDelay()</code> - Explicit delay</li>
                        <li><code>xQueueReceive()</code> with timeout - Wait for data</li>
                        <li><code>xSemaphoreTake()</code> with timeout - Wait for resource</li>
                        <li><code>ulTaskNotifyTake()</code> with timeout - Wait for notification</li>
                    </ul>
                </div>

                <div class="mermaid-container">
                    <div class="mermaid">
                        graph TD
                            A[Task Runs] --> B{Has vTaskDelay<br/>or blocking call?}
                            B -->|Yes| C[Task Blocks/Yields]
                            B -->|No| A
                            C --> D[Scheduler Runs]
                            D --> E[IDLE Task Runs]
                            E --> F[Feeds Watchdog]
                            F --> G[Other Tasks Run]
                            G --> A
                            
                            A2[Tight Loop Task] --> B2{Has vTaskDelay?}
                            B2 -->|No| A2
                            B2 -.->|Never| X[IDLE Never Runs]
                            X --> Y[Watchdog Starves]
                            Y --> Z[SYSTEM RESET!]
                            
                            style A fill:#e8f5e9,stroke:#4caf50
                            style C fill:#e8f5e9,stroke:#4caf50
                            style F fill:#c8e6c9,stroke:#2e7d32
                            style A2 fill:#ffebee,stroke:#dc3545
                            style Z fill:#ffcdd2,stroke:#c62828
                    </div>
                </div>

                <div class="info-box">
                    <h3>scanf() vs fgets() + sscanf()</h3>
                    
                    <div class="comparison-grid">
                        <div class="comparison-item bad">
                            <h4>‚ùå scanf()</h4>
                            <ul>
                                <li><strong>No buffer control</strong> - Can overflow</li>
                                <li><strong>Blocks indefinitely</strong> - Waits for exact format match</li>
                                <li><strong>Leaves newlines</strong> in buffer</li>
                                <li><strong>Hard to validate</strong> - Acts immediately</li>
                                <li><strong>Error prone</strong> - Fails on unexpected input</li>
                            </ul>
                        </div>
                        
                        <div class="comparison-item good">
                            <h4>‚úÖ fgets() + sscanf()</h4>
                            <ul>
                                <li><strong>Buffer safe</strong> - Size guaranteed</li>
                                <li><strong>Returns NULL</strong> - Non-blocking check</li>
                                <li><strong>Clean input</strong> - Reads full line</li>
                                <li><strong>Easy validation</strong> - Parse in memory first</li>
                                <li><strong>Robust</strong> - Handles any input gracefully</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="info-box">
                    <h3>Stack Overflow Detection</h3>
                    <p><strong>ESP-IDF provides stack watermark checking:</strong></p>
                    <div class="code-block">UBaseType_t uxHighWaterMark = uxTaskGetStackHighWaterMark(NULL);
ESP_LOGI(TAG, "Stack remaining: %d bytes", uxHighWaterMark);

// If return value < 256: WARNING - Stack too small!
// If return value < 100: DANGER - Will crash soon!</div>
                    
                    <p><strong>Stack Sizing Guidelines:</strong></p>
                    <table>
                        <tr>
                            <th>Task Type</th>
                            <th>Recommended Stack</th>
                        </tr>
                        <tr>
                            <td>Simple task (no printf)</td>
                            <td>1024 - 2048 bytes</td>
                        </tr>
                        <tr>
                            <td>Task with printf/logging</td>
                            <td>2048 - 3072 bytes</td>
                        </tr>
                        <tr>
                            <td>Task with scanf/fgets</td>
                            <td>4096+ bytes</td>
                        </tr>
                        <tr>
                            <td>WiFi/Network tasks</td>
                            <td>4096 - 8192 bytes</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Before/After Comparison -->
            <div class="section">
                <h2 class="section-title">üìä Before vs After Comparison</h2>

                <table>
                    <tr>
                        <th>Aspect</th>
                        <th>Before (Broken)</th>
                        <th>After (Fixed)</th>
                    </tr>
                    <tr>
                        <td><strong>Loop Blocking</strong></td>
                        <td style="color: #dc3545;">‚ùå No delay - tight loop</td>
                        <td style="color: #4caf50;">‚úÖ vTaskDelay(100ms)</td>
                    </tr>
                    <tr>
                        <td><strong>Stack Size</strong></td>
                        <td style="color: #dc3545;">‚ùå 2048 bytes (too small)</td>
                        <td style="color: #4caf50;">‚úÖ 4096 bytes (safe)</td>
                    </tr>
                    <tr>
                        <td><strong>Input Method</strong></td>
                        <td style="color: #dc3545;">‚ùå scanf() - unsafe</td>
                        <td style="color: #4caf50;">‚úÖ fgets() + sscanf() - safe</td>
                    </tr>
                    <tr>
                        <td><strong>Validation</strong></td>
                        <td style="color: #dc3545;">‚ùå None - accepts any data</td>
                        <td style="color: #4caf50;">‚úÖ Range checks before queue</td>
                    </tr>
                    <tr>
                        <td><strong>Queue Sends</strong></td>
                        <td style="color: #dc3545;">‚ùå Every loop (spam)</td>
                        <td style="color: #4caf50;">‚úÖ Only on valid input</td>
                    </tr>
                    <tr>
                        <td><strong>Watchdog</strong></td>
                        <td style="color: #dc3545;">‚ùå Triggers timeout</td>
                        <td style="color: #4caf50;">‚úÖ Fed properly</td>
                    </tr>
                    <tr>
                        <td><strong>System Stability</strong></td>
                        <td style="color: #dc3545;">‚ùå Crashes in ~5 seconds</td>
                        <td style="color: #4caf50;">‚úÖ Runs indefinitely</td>
                    </tr>
                </table>
            </div>

            <!-- Key Takeaways -->
            <div class="section">
                <h2 class="section-title">üéì Key Takeaways</h2>

                <div class="info-box">
                    <h3>Critical FreeRTOS Rules</h3>
                    <ol>
                        <li><strong>ALWAYS include a blocking call or delay in task loops</strong>
                            <ul>
                                <li>Use <code>vTaskDelay()</code> if nothing else</li>
                                <li>Queue/semaphore waits count as blocking</li>
                            </ul>
                        </li>
                        <li><strong>Size stacks appropriately for task workload</strong>
                            <ul>
                                <li>Start with 4096 for tasks using stdio</li>
                                <li>Monitor with <code>uxTaskGetStackHighWaterMark()</code></li>
                            </ul>
                        </li>
                        <li><strong>Validate input before sending to queues/semaphores</strong>
                            <ul>
                                <li>Garbage in = system crash out</li>
                                <li>Embedded systems can't afford assumptions</li>
                            </ul>
                        </li>
                        <li><strong>Use safe string functions</strong>
                            <ul>
                                <li><code>fgets()</code> > <code>gets()</code> or raw <code>scanf()</code></li>
                                <li><code>strncpy()</code> > <code>strcpy()</code></li>
                                <li><code>snprintf()</code> > <code>sprintf()</code></li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <div class="info-box">
                    <h3>Debugging Watchdog Timeouts</h3>
                    <p><strong>When you see:</strong> "Task watchdog got triggered. The following tasks did not reset the watchdog in time:"</p>
                    
                    <p><strong>Check for:</strong></p>
                    <ul>
                        <li>Infinite loops without <code>vTaskDelay()</code></li>
                        <li>While loops waiting for condition that never happens</li>
                        <li>Tasks holding mutexes for too long</li>
                        <li>Deadlocks between tasks</li>
                    </ul>
                    
                    <p><strong>Solution:</strong> Add periodic yield points (<code>vTaskDelay()</code>) or proper blocking operations.</p>
                </div>

                <div class="solution-box">
                    <h3>Professional Embedded Best Practices Applied</h3>
                    <ul>
                        <li>‚úÖ <strong>Defensive programming</strong> - Validate all inputs</li>
                        <li>‚úÖ <strong>Resource awareness</strong> - Proper stack sizing</li>
                        <li>‚úÖ <strong>Cooperative multitasking</strong> - Yield regularly</li>
                        <li>‚úÖ <strong>Safe string handling</strong> - Bounded buffers</li>
                        <li>‚úÖ <strong>Error checking</strong> - Verify return values</li>
                    </ul>
                </div>
            </div>

            <!-- Testing -->
            <div class="section">
                <h2 class="section-title">üß™ Testing the Fix</h2>

                <div class="info-box">
                    <h3>Commands to Try</h3>
                    <div class="code-block">pattern 0      ‚Üê Knight Rider
pattern 1      ‚Üê Blink All
pattern 2      ‚Üê Alternating
pattern 3      ‚Üê Random
speed 200      ‚Üê Fast
speed 800      ‚Üê Slow
status         ‚Üê Show system info

// Invalid (should be rejected):
pattern 99     ‚Üê Out of range
speed 2000     ‚Üê Too high
destroy        ‚Üê Unknown command</div>
                </div>

                <div class="solution-box">
                    <h3>Expected Behavior</h3>
                    <ul>
                        <li>System runs indefinitely without crashes</li>
                        <li>Valid commands execute immediately</li>
                        <li>Invalid commands logged but ignored</li>
                        <li>No watchdog timeouts</li>
                        <li>Stack high watermark > 1000 bytes remaining</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>